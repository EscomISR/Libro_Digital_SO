<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad 2.3: Comunicaci贸n entre procesos (IPC)</title>
    <link rel="icon" type="image/png" href="../IMAGENES/logoescom.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #8e44ad; /* Morado para Unidad 2 */
            --success: #2ecc71;
            --accent: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #1a2a3a;
            --gray: #95a5a6;
            --item-bg: rgba(255, 255, 255, 0.05);
            --item-hover: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: var(--light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Estilos Generales --- */
        .sidebar-nav {
            position: fixed; left: 0; top: 0; width: 280px; height: 100vh;
            background: rgba(0,0,0,.95); backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255,255,255,.1); z-index: 1000;
            transform: translateX(-100%); transition: transform .3s ease;
            padding-top: 60px;
        }
        .sidebar-nav.active { transform: translateX(0); }
        
        .menu-toggle {
            position: fixed; top: 20px; left: 20px; z-index: 1001;
            background: var(--secondary); color: white; width: 45px; height: 45px;
            border: none; border-radius: 8px; cursor: pointer; font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .container {
            max-width: 1200px; margin: 0 auto; padding: 20px 20px 40px;
            transition: margin-left .3s;
        }

        .header {
            text-align: center; padding: 30px;
            background: rgba(0,0,0,.4); border-radius: 15px; margin-bottom: 30px;
            border: 1px solid rgba(142, 68, 173, 0.3);
        }
        h1 { font-size: 2.5rem; margin-bottom: 10px; color: #fff; text-shadow: 0 0 10px var(--secondary); }
        .subtitle { color: var(--gray); font-size: 1.1rem; }

        /* --- rea de Juego (Relacionar) --- */
        .game-area {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px; padding: 30px;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }

        .stats-bar {
            display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px;
            margin-bottom: 30px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;
        }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--secondary); }
        .stat-label { font-size: 0.9rem; color: var(--gray); }

        /* Contenedor de las Columnas y SVG */
        .matching-container {
            display: flex; justify-content: space-between; align-items: stretch;
            position: relative; min-height: 400px;
        }

        /* SVG Overlay para las l铆neas */
        #connections-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1;
        }

        .column {
            width: 45%; display: flex; flex-direction: column; gap: 20px; z-index: 2;
        }
        
        .column-title {
            text-align: center; font-size: 1.2rem; font-weight: bold;
            color: var(--secondary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;
        }

        .match-item {
            background: var(--item-bg); padding: 20px; border-radius: 10px;
            border: 2px solid transparent; cursor: pointer;
            transition: all 0.3s ease; position: relative;
            display: flex; align-items: center; justify-content: center;
            min-height: 80px; text-align: center; font-weight: 500;
            user-select: none;
        }

        .match-item:hover { background: var(--item-hover); transform: translateY(-2px); }
        
        /* Estados de los items */
        .match-item.selected {
            border-color: var(--warning); background: rgba(243, 156, 18, 0.1);
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.2);
        }
        .match-item.matched {
            border-color: var(--success); background: rgba(46, 204, 113, 0.1);
            color: var(--success); cursor: default; transform: none;
        }
        .match-item.error {
            animation: shake 0.5s; border-color: var(--accent);
        }

        /* Puntos de conexi贸n visuales */
        .connector-point {
            position: absolute; width: 12px; height: 12px;
            background: var(--gray); border-radius: 50%;
            top: 50%; transform: translateY(-50%);
            transition: background 0.3s;
        }
        .col-left .connector-point { right: -6px; }
        .col-right .connector-point { left: -6px; }

        .match-item.selected .connector-point { background: var(--warning); box-shadow: 0 0 10px var(--warning); }
        .match-item.matched .connector-point { background: var(--success); box-shadow: 0 0 10px var(--success); }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Controles */
        .controls {
            display: flex; justify-content: center; gap: 15px; margin-top: 40px;
        }
        .btn {
            padding: 12px 25px; border-radius: 30px; border: none; font-weight: bold;
            cursor: pointer; transition: 0.3s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-reset { background: var(--gray); color: white; }
        .btn-reset:hover { background: #7f8c8d; }
        
        /* Modales / Mensajes */
        .game-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .game-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: #202025; padding: 40px; border-radius: 20px;
            text-align: center; border: 2px solid var(--secondary);
            max-width: 500px; width: 90%; transform: scale(0.9); transition: 0.3s;
        }
        .game-overlay.visible .modal-content { transform: scale(1); }
        .modal-icon { font-size: 4rem; margin-bottom: 20px; color: var(--secondary); }
        
        @media (max-width: 768px) {
            .matching-container { flex-direction: column; gap: 20px; }
            .column { width: 100%; }
            #connections-layer { display: none; }
            .connector-point { display: none; }
        }
    </style>
</head>
<body>

    <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
    <nav class="sidebar-nav" id="sidebar">
        <div style="padding: 20px;">
            <h3 style="color: var(--secondary); margin-bottom: 20px;">Unidad 2: Procesos</h3>
            <a href="2.3.html" style="display: block; color: white; text-decoration: none; margin-bottom: 15px; padding: 10px; border-radius: 5px; background: rgba(255,255,255,0.1);"><i class="fas fa-arrow-left"></i> Volver al contenido</a>
            <a href="index.html" style="display: block; color: var(--gray); text-decoration: none; margin-bottom: 15px;"><i class="fas fa-home"></i> Men煤 Principal</a>
        </div>
    </nav>

    <div class="container">
        <header class="header">
            <h1> Conexiones IPC</h1>
            <div class="subtitle">Actividad 2.3: Comunicaci贸n entre procesos</div>
        </header>

        <div class="game-area">
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="timer">00:00</div>
                    <div class="stat-label">Tiempo</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value"><span id="matches-count">0</span> / <span id="total-pairs">0</span></div>
                    <div class="stat-label">Aciertos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="errors-count" style="color: var(--accent);">0</div>
                    <div class="stat-label">Errores</div>
                </div>
            </div>

            <div class="matching-container" id="gameBoard">
                <svg id="connections-layer"></svg>
                
                <div class="column col-left" id="column-left">
                    <div class="column-title">Mecanismo / Concepto</div>
                    </div>
                
                <div class="column col-right" id="column-right">
                    <div class="column-title">Descripci贸n</div>
                    </div>
            </div>

            <div class="controls">
                <button class="btn btn-reset" onclick="initGame()">
                    <i class="fas fa-redo"></i> Reiniciar
                </button>
            </div>
        </div>
    </div>

    <div class="game-overlay" id="victoryModal">
        <div class="modal-content">
            <div class="modal-icon"></div>
            <h2>隆Comunicaci贸n Establecida!</h2>
            <p>Has conectado correctamente los mecanismos de IPC.</p>
            <p style="margin: 15px 0; color: var(--gray);">Tiempo: <span id="final-time">00:00</span> | Errores: <span id="final-errors">0</span></p>
            <button class="btn" style="background: var(--success); color: white;" onclick="window.location.href='2.4.html'">
                Siguiente Tema <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIN Y ESTADO DEL JUEGO
        // ==========================================
        const state = {
            selectedLeft: null,
            selectedRight: null,
            matches: [], // Array de {leftId, rightId, color}
            isLocked: false,
            timerInterval: null,
            seconds: 0,
            errors: 0,
            pairs: [] // Se cargar谩 del JSON
        };

        const colors = [
            '#e74c3c', '#8e44ad', '#3498db', '#e67e22', '#2ecc71', 
            '#1abc9c', '#d35400', '#c0392b'
        ]; // Colores para las l铆neas

        // ==========================================
        // INICIALIZACIN
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
            
            // Toggle Men煤
            document.getElementById('menuToggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#sidebar') && !e.target.closest('#menuToggle')) {
                    document.getElementById('sidebar').classList.remove('active');
                }
            });
        });

        async function initGame() {
            // Reset Estado
            state.selectedLeft = null;
            state.selectedRight = null;
            state.matches = [];
            state.isLocked = false;
            state.seconds = 0;
            state.errors = 0;
            state.pairs = [];
            
            document.getElementById('connections-layer').innerHTML = '';
            document.getElementById('column-left').innerHTML = '<div class="column-title">Mecanismo / Concepto</div>';
            document.getElementById('column-right').innerHTML = '<div class="column-title">Descripci贸n</div>';
            document.getElementById('victoryModal').classList.remove('visible');
            updateStats();
            clearInterval(state.timerInterval);
            state.timerInterval = setInterval(updateTimer, 1000);

            try {
                // Cargar datos
                const response = await fetch('preguntas_2.3.json'); 
                const data = await response.json();
                
                // Preparar datos
                state.pairs = data.map((item, index) => ({
                    id: index,
                    leftText: item.concepto || item.pregunta,
                    rightText: item.definicion || item.respuesta_correcta
                }));

                // Barajar independientemente
                const leftItems = [...state.pairs].sort(() => Math.random() - 0.5);
                const rightItems = [...state.pairs].sort(() => Math.random() - 0.5);

                renderColumn('column-left', leftItems, 'left');
                renderColumn('column-right', rightItems, 'right');
                
                document.getElementById('total-pairs').textContent = state.pairs.length;

            } catch (error) {
                console.error("Error cargando preguntas:", error);
                document.getElementById('gameBoard').innerHTML = `<div style="text-align:center; width:100%; padding:20px;">锔 Error cargando el archivo de preguntas (preguntas_2.3.json)</div>`;
            }
        }

        function renderColumn(containerId, items, side) {
            const container = document.getElementById(containerId);
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = `match-item col-${side}`;
                el.dataset.id = item.id;
                el.dataset.side = side;
                el.innerHTML = `
                    ${side === 'left' ? item.leftText : item.rightText}
                    <div class="connector-point"></div>
                `;
                el.onclick = () => handleItemClick(el, item.id, side);
                container.appendChild(el);
            });
        }

        // ==========================================
        // LGICA DE JUEGO
        // ==========================================
        function handleItemClick(element, id, side) {
            if (state.isLocked || element.classList.contains('matched')) return;

            // 1. Gestionar selecci贸n visual
            const currentSelected = side === 'left' ? state.selectedLeft : state.selectedRight;
            
            // Si ya estaba seleccionado, deseleccionar
            if (currentSelected === element) {
                element.classList.remove('selected');
                if (side === 'left') state.selectedLeft = null;
                else state.selectedRight = null;
                return;
            }

            // Deseleccionar previo en la misma columna
            const prev = document.querySelector(`.col-${side}.selected`);
            if (prev) prev.classList.remove('selected');

            // Seleccionar nuevo
            element.classList.add('selected');
            if (side === 'left') state.selectedLeft = element;
            else state.selectedRight = element;

            // 2. Verificar Match si ambos lados tienen selecci贸n
            if (state.selectedLeft && state.selectedRight) {
                checkMatch();
            }
        }

        function checkMatch() {
            state.isLocked = true;
            const leftId = parseInt(state.selectedLeft.dataset.id);
            const rightId = parseInt(state.selectedRight.dataset.id);

            if (leftId === rightId) {
                // --- ACIERTO ---
                handleSuccess();
            } else {
                // --- ERROR ---
                handleError();
            }
        }

        function handleSuccess() {
            const color = colors[state.matches.length % colors.length];
            
            state.selectedLeft.classList.add('matched');
            state.selectedRight.classList.add('matched');
            state.selectedLeft.style.borderColor = color;
            state.selectedRight.style.borderColor = color;
            
            // Guardar conexi贸n para redibujar si cambia tama帽o
            state.matches.push({
                left: state.selectedLeft,
                right: state.selectedRight,
                color: color
            });

            drawAllConnections();
            
            state.selectedLeft.classList.remove('selected');
            state.selectedRight.classList.remove('selected');
            state.selectedLeft = null;
            state.selectedRight = null;
            state.isLocked = false;
            
            updateStats();
            checkWin();
        }

        function handleError() {
            state.errors++;
            state.selectedLeft.classList.add('error');
            state.selectedRight.classList.add('error');
            updateStats();

            setTimeout(() => {
                state.selectedLeft.classList.remove('selected', 'error');
                state.selectedRight.classList.remove('selected', 'error');
                state.selectedLeft = null;
                state.selectedRight = null;
                state.isLocked = false;
            }, 800);
        }

        // ==========================================
        // DIBUJADO DE LNEAS (SVG)
        // ==========================================
        function drawAllConnections() {
            const svg = document.getElementById('connections-layer');
            svg.innerHTML = ''; // Limpiar
            
            // Ajustar tama帽o del SVG al contenedor
            const container = document.getElementById('gameBoard');
            const rect = container.getBoundingClientRect();
            
            // En m贸vil no dibujamos l铆neas porque las columnas se apilan
            if (window.innerWidth <= 768) return;

            state.matches.forEach(match => {
                const p1 = getConnectorPosition(match.left, 'left');
                const p2 = getConnectorPosition(match.right, 'right');
                
                // Coordenadas relativas al SVG
                const x1 = p1.x - rect.left;
                const y1 = p1.y - rect.top;
                const x2 = p2.x - rect.left;
                const y2 = p2.y - rect.top;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                // Curva Bezier
                const d = `M ${x1} ${y1} C ${x1 + 50} ${y1}, ${x2 - 50} ${y2}, ${x2} ${y2}`;
                
                path.setAttribute('d', d);
                path.setAttribute('stroke', match.color);
                path.setAttribute('stroke-width', '3');
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke-linecap', 'round');
                path.style.transition = 'all 0.5s ease';
                
                svg.appendChild(path);
            });
        }

        function getConnectorPosition(element, side) {
            const rect = element.getBoundingClientRect();
            return {
                x: side === 'left' ? rect.right : rect.left,
                y: rect.top + (rect.height / 2)
            };
        }

        // Redibujar al cambiar tama帽o de ventana
        window.addEventListener('resize', drawAllConnections);

        // ==========================================
        // UTILIDADES Y ESTADSTICAS
        // ==========================================
        function updateStats() {
            document.getElementById('matches-count').textContent = state.matches.length;
            document.getElementById('errors-count').textContent = state.errors;
        }

        function updateTimer() {
            state.seconds++;
            const m = Math.floor(state.seconds / 60).toString().padStart(2, '0');
            const s = (state.seconds % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `${m}:${s}`;
        }

        function checkWin() {
            if (state.matches.length === state.pairs.length && state.pairs.length > 0) {
                clearInterval(state.timerInterval);
                document.getElementById('final-time').textContent = document.getElementById('timer').textContent;
                document.getElementById('final-errors').textContent = state.errors;
                setTimeout(() => {
                    document.getElementById('victoryModal').classList.add('visible');
                }, 500);
            }
        }

    </script>
</body>
</html>